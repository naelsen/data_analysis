---
title: "Projet Analyse de données"
author: "RAHBI Aissam & SENNOUN Naël"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 4
---

```{r, echo=FALSE}
# Reset de l'environnement
rm(list=ls())
# Import des librairies nécessaires pour les analyses.
library(FactoMineR)
library(MASS)
library(rmarkdown)
```

# Introduction des données

On voit que les deux premières colonnes (X & id) sont inutiles pour nos analyses, on va donc les supprimer.
```{r}
data <- read.csv("data/train.csv") 
data <- data[!rowMeans(is.na(data)*1) > 0,] # On supprime les lignes ou il y a des valeurs manquantes
str(data)
```

```{r}
# On retire les colonnes inutiles
data <- data[,c(-1,-2)]
# On garde les 5000 premieres lignes
data <- data[1:5000,]
# On modifie les noms des lignes pour le style ;-)
row.names(data) <- paste("n°", sep="", 1:dim(data)[1]) 
# On renomme les colonnes pour avoir des noms moins longs (Utile pour l'affichage)
colnames(data) <- c("Genre", "Fidélité", "Age", "Type.du.vol", "Classe", "Distance", "Wifi", "Horaire.pratique", "Facilité.resevation", "Emplacement.porte", "Nourriture", "Enregistrement.en.ligne", "Siege.confort", "Loisir", "On.board.service", "Espace.jambe", "Gestion.bagage", "Checkin.service", "Inflight.service", "Propreté", "Retard.depart", "Retard.arrivé", "Satisfaction")
```

Petit avant gout des données :
```{r}
paged_table(data)
```

* Les femmes sont autant présentes que les hommes (en haut à gauche)
* Il y a plus de personnes qui voyagent pour une raison professionnelle que personnelle (en haut à droite)
* Il y a plus de loyal customer que de non loyal (en bas à gauche)
* Les voyageurs en classe Éco Plus representent une petite partie, quant aux classes business et éco ils representent un peu moins de la moitié du vol (en bas à droite)
* Pour finir un peu plus de voyageur sont neutres ou ne sont pas satisfaits de leur voyage que satisfait (au milieu)

```{r}
par(fig=c(0,1/2,1/2,1))
pie(table(data$Genre), col = c("pink","blue"),cex=0.8)
par(fig=c(0,1/2,0,1/2),new=TRUE)
pie(table(data$Fidélité), col = c("red","green"),cex=0.8)
par(fig=c(1/2,1,1/2,1),new=TRUE)
pie(table(data$Type.du.vol), col = rainbow(2), cex=0.8)
par(fig=c(1/2,1,0,1/2),new=TRUE)
pie(table(data$Classe), col = rainbow(3),cex=0.8)
par(fig=c(1/3-1/5,2/3+1/5,1/3-1/5,2/3+1/5),new=TRUE)
pie(table(data$Satisfaction), col=c("red","green"), cex=0.8)
```

Les notes sont assez homogènes, elles ont toutes :

* Un 1er quartile égal à 2 ou 3

* Une médiane égal à 3 ou 4.

* Un 3-ème quartile égale à 4 ou 5.

* Les moyennes pour les notes vont de 2.74 à 3.65.

```{r}
summary(data[,7:20])
```
On peut aussi observer les autres variables quantitatives :

* L'Âge est une donnée qui à vu d'oeil est très probablement Gaussienne centrée autour de 40
* La variable distance est une donnée qui parrait assez équlibrée
* Pour les retards il y a énormement de données abérrantes

```{r}
par(mfrow=c(2,2))
boxplot(data$Age, main="Âge")
boxplot(data$Distance, main="Distance")
boxplot(data$Retard.depart, main="Retard depart")
boxplot(data$Retard.arrivé, main="Retard arrivée")
```



# Analyse des données

## Test paramétrique

```{r}

```


## ACP

On récupère toutes les données quantitatives et la satisfaction.

On ne prend que les 5000 premières lignes car le data set est trop gros (+100 000 lignes)

```{r}
# On récupère Âge/Distance du vol/Retard Depart/Retard Arrivé (colonne 3/6/21/22), les notes (colonnes 7 à 20) et la satisfaction (colonne 23)
data_bis <- data[,c(3,6,21,22,7:20,23)]
res <- PCA(data_bis, quanti.sup=1:4, quali.sup=19, graph=FALSE)
```


Il est évident de penser que les notes attribuées par les voyageurs influent sur leur satisfaction, on peut le voir avec le graphe ci- dessous. Pour ne pas attribuer trop d'importance aux moyennes donner par des individus, on associe un poids qui correspond à la taille du groupe pour chaque moyenne attribuée.
```{r, echo=FALSE}
mean_notes <-rowMeans(data[,7:20])
barplot((table(as.factor(mean_notes),data$Satisfaction)/rowSums(table(as.factor(mean_notes),data$Satisfaction)))[,2],
        width=rowSums(table(as.factor(mean_notes),data$Satisfaction)),
        col=rainbow(n=52,alpha=0.7,start=0,end=0.35),
        main = "Fréquence de satisfaction en fonction de la moyenne des notes",
        xlab = "Note moyenne",
        ylab = "Pourcentage d'individus satisfaits")
```

Ainsi, on va faire notre ACP sur les notes.

***
Les individus ou variables peuvent être proches dans le plan mais eloignés dans l'espace s'ils sont mal représentés dans le plan.
Ainsi, il est important d'expliquer les individus avec des variables bien representées dans le plan.
Pour cela on veillera à ne pas prendre les variables et individus ayant un cos2 trop bas. Ici on choisit un cos2 égale à 0.58 afin qu'il ne soit pas trop bas et qu'on ait au moins 4 variables à utiliser afin d'expliquer nos individus sur les axes 1 et 2.

Ici l'axe 1 va faire le contraste entre le confort à bord (droite) et l'inconfort (gauche), tandis que l'axe 2 fera le contraste entre les aspects techniques pour ce qui concerne le vol.

Les variables quantitatives supplémentaires ne sont pas du tout interprétables
```{r}
plot(res,select="cos2 0.58", choix="varcor")
```


On peut voir une nette séparation entre les individus satisfaits et non satisfaits. Les individus satisfaits sont ceux s'étant amusé et ayant trouvé l'avion propre. À l'inverse les individus non satisfaits ont octroyé des notes plus basses concernant la propreté et les loisirs. On ne peut pas vraiment dire pour l'instant si la facilité de réservation et le wifi à bord influent sur la satisfaction du passager.
Ici par exemple l'individu n°3297 est satisfait, or il a mal noté les loisirs, la propreté, le wifi et la facilité de réservation. Sa satisfaction est probablement influencé par d'autres variables, qui sont qualitatives. On se penchera sur ce sujet lors de l'ACM. 

```{r}
plot(res,habillage=19, select="cos2 0.8", choix="ind",cex = 0.6)
```

L'individu qui contribue le plus à l'axe 1 y contribue à 0.15%.

Il y a 40 individus qui y contribuent pour plus de 0.1%

On n'a pas d'individus atypiques, ce qui est normal car nos données sont des notes entre 0 et 5 et on a vu qu'elles étaient assez homogènes
```{r}
max(res$ind$contrib[,1])
sum((res$ind$contrib[,1] > 0.1)*1)
```

On peut voir premièrement que les 3 premiers axes expliquent bien l'inertie sur les données. 
Les axes étant orthogonaux, les axes 1 et 2 prennent en compte 27.01% + 16.87% = 43.88% du jeu de données expliquent 44.56% de l'inertie.
On peut aussi voir que l'axe 2 et 3 expliquent à peu près autant l'un que l'autre l'inertie, ainsi on pourra aussi visualiser les données projetées sur le plan formé par l'axe 1 et 3 (même 2 et 3).
```{r}
barplot(res$eig[,2], col=rainbow(n=14,alpha=0.6,start=0,end=0.33),main="Pourcentage d'inertie expliquée par chaque axe", ylab="Contribution en %")
lines(seq(0.75,16.3,(16.3-0.75)/13),res$eig[,2],type="b", xlim=c(0,max(res$eig[,2])+10))
text(seq(0.75,16.3,(16.3-0.75)/13),res$eig[,2]-1, paste(round(res$eig[,2],2),"%"), cex=0.7)
#text(5,22,paste(round(res$eig[,2],2)[1],"% +",round(res$eig[,2],2)[2],"% = ",round(res$eig[,2],2)[1]+round(res$eig[,2],2)[2],"%",sep=""))
```

On a un nouveau cercle de corrélation, ici on voit que :

* Le confort des sièges, la nourriture et la propreté sont fortement corrélés
* La gestion des bagages et les services proposés sont fortement corrélés
* Dans ce plan les loisirs sont presque totalement expliqués par l'axe 1
* L'axe 3 oppose le "confort" aux services qui sont faiblement corrélés dû à l'angle proche de 90 degrés


```{r}
plot(res, select="cos2 0.58", choix="varcor", axes = c(1,3))
```
On voit sur ce cercle de corrélation que les 

```{r}
#chisq.test(table(as.factor(data_bis$Propreté), as.factor(data_bis$Gestion.bagage)))
boxplot( data_bis$Loisir ~ data_bis$Gestion.bagage)
points(tapply(data_bis$Loisir , data_bis$Gestion.bagage ,mean), col = 'red')

boxplot( data_bis$Nourriture ~ data_bis$Siege.confort)
points(tapply(data_bis$Nourriture , data_bis$Siege.confort ,mean), col = 'red')
```



Les passagers sont en général plus satisfait quand ils se sont amusé (loisirs), que le service était agréable(Gestion bagage, Inflight.service, On.board.service) et qu'ils ont passé un vol confortable (Siege.confort, nourriture, propreté), et inversement pour les passagers non satisfaits.
```{r}
plot(res, habillage=19, select="cos2 0.58", choix="ind", axes = c(1,3))
```

Ici on a le cercle de corrélation avec l'axe 2 et 3:
```{r}
plot(res, select="cos2 0.6", choix="varcor", axes = c(2,3))
```
Il n'y a pas grand-chose à interpréter car le barycentre des voyageurs satisfaits et non satisfaits sont tout les 2 proches du centre de gravité de ce plan.
```{r}
plot(res, invisible="ind",choix="ind", axes = c(2,3))
```

### Transformations & double centrage

Certains passagers ont attribué comme notes 0 pour certaines catégories du vol, on décide de ne pas faire de transformation par l'inverse car $\frac{1}{0}$ est un quotient indéterminé 

#### Log-transformation
On effectue la transformation ”double centrage” sur les données log-transformées afin de voir si on peut faire gagner en contribution les premières composantes afin d'être plus précis lors de nos analyses.
```{r}
data_bis2 <- log(data_bis[,c(-4:-1,-19)])
data_bis2 <- t(scale(t(data_bis2)))
res2 <- PCA(data_bis2, graph=FALSE)
barplot(res2$eig[,2], col=rainbow(n=14,alpha=0.6,start=0.33,end=0.66),main="Pourcentage d'intertie expliquée par chaque axe\n(Données log-transformées) ", ylab="Contribution en %")
lines(seq(0.75,16.3,(16.3-0.75)/13),res2$eig[,2],type="b")
text(seq(0.75,16.3,(16.3-0.75)/13),res2$eig[,2]-1, paste(round(res2$eig[,2],2),"%"), cex=0.7)
```

#### Transformation par racines carrée
On effectue la transformation ”double centrage” sur les données transformées par racine carrée afin de voir si on peut faire gagner en contribution les premières composantes afin d'être plus précis lors de nos analyses.
```{r}
data_bis3 <- sqrt(data_bis[,c(-4:-1,-19)])
data_bis3 <- t(scale(t(data_bis3)))
res3 <- PCA(data_bis3, graph=FALSE)
barplot(res3$eig[,2], col=rainbow(n=14,alpha=0.6,start=0.66,end=1),main="Pourcentage d'intertie expliquée par chaque axe\n(Données transformées par racine carrée)", ylab="Contribution en %")
lines(seq(0.75,16.3,(16.3-0.75)/13),res3$eig[,2],type="b")
text(seq(0.75,16.3,(16.3-0.75)/13),res3$eig[,2]-1, paste(round(res3$eig[,2],2),"%"), cex=0.7)
```

Les transformations ne nous ont pas fait gagner plus d'informations au niveau des 2 premiers axes, on s'arrête là pour l'ACP.

### Conclusion ACP

Ici on a pu étudier l'impacte des variable quantitative sur la satisfaction des gens pour un trajet en avion.
Il en est ressorti que les services proposés dans l'avion et le confort à bord sont des aspects primordiaux pour la satisfaction des voyageurs.


## ACM

```{r}
data_bis <- data[,c(1,2,4,5,23)]
paged_table(data_bis)
```


```{r}
res.mca <-MCA(data_bis, quali.sup = 5, graph=FALSE)
```


D'abbord on peut observer que la première dimension influe à un peu plus de 30% quant à la 2, 3, 4 elles influent toutes autour de 20%.
Il sera donc surement nécessaire de s'intéresser à ces 4 dimensions.

```{r}
barplot(res.mca$eig[,2], col=rainbow(5))
```


```{r}
par(mfrow = c(2,2))
for(i in 1:4){
  barplot(res.mca$var$cos2[,i], las = 2, cex.names = 0.64, 
          col=rainbow(n=9,alpha=0.6,start=(i-1)/4,end=i/4),
          main=paste("Cos2 des modalités pour l'axe",i))
}
```
En se referent aux cos2 (cos2 > 0.7) des barplots précédents : 

L'axe 1 oppose les passagers qui voyagent pour le business et les passagers qui voyagent pour un motif personnel. Ceux qui voyagent pour le travail sont en général plus satisfaits et ceux qui voyagent pour un motif personnel sont en général sans avis ou insatisfaits.
L'axe 2 oppose les passagers loyaux aux non loyaux, il en résulte que le passagers non loyaux sont plus souvent insatisfaits et que les passagers loyaux.
Les 2 axes prennent aussi en compte a eux deux les voyageurs qui voyagent en business et en éco.
On peut voir que les voyageurs en éco sont plus souvent insatisfait de leur voyage que ceux en business classe.

```{r}
plot(res.mca, invisible="ind", axes=c(1,2))
```

En se referent aux cos2 (cos2 > 0.7) pour l'axe 3 des barplots précédents : 

On peut voir que l'axe 3 oppose les personnes de sexe different, on ne peut pas dire grand-chose quant à l'influence sur la satisfaction du client, on pourrait peut-être dire que les femmes sont un peu moins satisfaites mais c'est à vérifier.

```{r}
plot(res.mca, invisible="ind", axes=c(1,3))
```


Pour prendre en compte les voyageurs classe éco plus on visualise sur le plan formé par l'axe 3 et 4

On peut voir ici que les voyageurs en classe Éco Plus sont moins satisfaits de leur voyages, ils sont très excentrés car ils représentes des données inhabituelles.


```{r}
plot(res.mca, invisible="ind", axes=c(3,4))
```

Rappelez-vous de l'individu n°3297, il était satisfait de son vol malgré les mauvaises notes attribués aux différentes catégories. On voit qu'il possède toutes les modalités influant positivement sur la satisfaction. Ceci montre bien que l'analyse des données qualitatives est importante car on a eu des informations qu'on ne pouvait pas avoir avec l'ACP.
```{r, echo=FALSE}
paged_table(data[3297,])
```


### Conclusion

D'après l'ACM :

* Si un passager voyage pour des raisons personnelles, il a moins de chance d'être satisfait du vol qu'un passager qui voyage pour le business.

* Si le passager est un client fidèle (Loyal custommer) il a plus de chance d'être satisfait du vol qu'un passager qui est déloyal (Disloyal custommer).

* Si un voyageur est en classe business, cela influera positivement sur sa satisfaction, alors que s'il est en classe Eco cela influera négativement. Les passagers Éco plus sont particuliers, mais le fait d'être en classe Éco plus influe négativement sur leur satisfaction.

* Le sexe de l'individu n'a pas l'air d'influer significativement sur la satisfaction, mais on peut faire l'hypothèse que les femmes sont moins satisfaites que les hommes.

## Anova

Nous allons à présent nous pencher sur la corrélation entre les différentes variables. En observant

```{r}
data_bis = data[,7:20]
mean_notes <-rowMeans(data_bis)

data[1:20,23]
plot(mean_notes[1:20])
boxplot( data_bis$Nourriture ~ data_bis$Gestion.bagage)
points(tapply(data_bis$Nourriture, data_bis$Gestion.bagage ,mean), col = 'red')
res = lm(formula =  data_bis$Wifi ~ data_bis$Propreté)
summary(res)
anova(res)
```



